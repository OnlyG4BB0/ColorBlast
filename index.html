<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reflex Master: Neon Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #ff0055;
            --accent: #ffee00;
            --bg-dark: #0a0a12;
            --bg-light: #1a1a2e;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; /* Nasconde cursore default */ }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 85, 0.1) 0%, transparent 20%);
            color: white;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- UI CONTAINER --- */
        .game-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 1400px;
            max-height: 900px;
            background: var(--glass);
            border: 1px solid var(--border);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        @media (min-width: 1024px) {
            .game-wrapper {
                margin: 20px;
                border-radius: 20px;
                height: calc(100vh - 40px);
            }
        }

        /* --- CURSOR --- */
        .cursor-dot, .cursor-circle {
            position: fixed;
            top: 0; left: 0;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            border-radius: 50%;
            mix-blend-mode: exclusion;
        }
        .cursor-dot { width: 8px; height: 8px; background: white; }
        .cursor-circle {
            width: 40px; height: 40px;
            border: 1px solid rgba(255,255,255,0.5);
            transition: width 0.2s, height 0.2s, background-color 0.2s;
        }
        .cursor-circle.hovered { width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-color: var(--primary); }
        
        /* Disable custom cursor on touch devices */
        @media (hover: none) and (pointer: coarse) {
            * { cursor: auto; }
            .cursor-dot, .cursor-circle { display: none; }
        }

        /* --- HUD --- */
        .hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 100;
            pointer-events: none; /* Click pass through */
        }

        .stat-box {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            min-width: 100px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .stat-label { font-size: 0.8rem; opacity: 0.7; letter-spacing: 1px; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 1.8rem; font-weight: 700; color: white; }
        .stat-box.score .stat-value { color: var(--accent); }
        .stat-box.time .stat-value { color: var(--primary); }
        .stat-box.combo .stat-value { color: var(--secondary); }

        .combo-bar-container {
            position: absolute;
            top: 90px; left: 50%;
            transform: translateX(-50%);
            width: 300px; height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            z-index: 90;
        }
        .combo-fill {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.1s linear;
        }

        /* --- GAME ELEMENTS --- */
        .game-area {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        .target {
            position: absolute;
            width: 70px; height: 70px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--bg-light) 30%, #2a2a40 100%);
            border: 2px solid white;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Orbitron', sans-serif; font-weight: bold; color: white;
            box-shadow: 0 0 15px currentColor;
            cursor: none;
            transform: translate(-50%, -50%) scale(0);
            animation: spawn 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards;
            transition: transform 0.1s;
        }
        
        .target::after {
            content: ''; position: absolute;
            top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%;
            border: 2px dashed currentColor;
            animation: spin 4s linear infinite;
        }

        @keyframes spawn { to { transform: translate(-50%, -50%) scale(1); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }

        .target.popped { animation: pop 0.2s ease-out forwards; pointer-events: none; }

        .powerup {
            position: absolute;
            width: 50px; height: 50px;
            transform: translate(-50%, -50%);
            font-size: 24px;
            display: flex; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 1px solid var(--accent);
            box-shadow: 0 0 20px var(--accent);
            animation: float 2s infinite ease-in-out;
            z-index: 15;
        }
        @keyframes float { 0%, 100% { transform: translate(-50%, -50%) translateY(0); } 50% { transform: translate(-50%, -50%) translateY(-10px); } }

        /* --- OVERLAYS (MENU, PAUSE, GAMEOVER) --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 18, 0.85);
            backdrop-filter: blur(15px);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 4rem;
            text-transform: uppercase;
            background: linear-gradient(to right, var(--primary), white, var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 2rem;
            text-shadow: 0 0 30px rgba(0, 243, 255, 0.5);
            text-align: center;
        }

        button {
            background: transparent;
            color: white;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            padding: 15px 40px;
            border: 1px solid var(--primary);
            border-radius: 4px;
            margin: 10px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        button:hover {
            background: var(--primary);
            color: black;
            box-shadow: 0 0 30px var(--primary);
            transform: translateY(-3px);
        }

        .pause-btn {
            pointer-events: all;
            background: rgba(255,255,255,0.1);
            border: none; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: none;
        }
        .pause-btn:hover { background: var(--secondary); transform: scale(1.1); }

        /* Floating Points Text */
        .float-text {
            position: absolute;
            font-family: 'Orbitron';
            font-weight: bold;
            pointer-events: none;
            animation: floatUp 0.8s ease-out forwards;
            z-index: 50;
            text-shadow: 0 0 5px black;
        }
        @keyframes floatUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1); opacity: 0; }
        }

        /* Responsive Text */
        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .stat-value { font-size: 1.2rem; }
            .stat-box { min-width: 70px; padding: 5px 10px; }
            .hud { padding: 10px; }
            .combo-bar-container { top: 70px; width: 200px; }
        }
    </style>
</head>
<body>

    <div class="cursor-dot"></div>
    <div class="cursor-circle"></div>

    <div class="game-wrapper">
        <!-- HUD -->
        <div class="hud">
            <div class="stat-box score">
                <div class="stat-label">SCORE</div>
                <div class="stat-value" id="score">0</div>
            </div>
            
            <div class="combo-bar-container">
                <div class="combo-fill" id="combo-bar"></div>
            </div>

            <div class="stat-box time">
                <div class="stat-label">TIME</div>
                <div class="stat-value" id="time">60</div>
            </div>

            <div class="stat-box combo">
                <div class="stat-label">COMBO</div>
                <div class="stat-value" id="combo">x1</div>
            </div>

            <button class="pause-btn" id="btn-pause">⏸</button>
        </div>

        <!-- Game Area -->
        <div class="game-area" id="game-area"></div>

        <!-- Start Screen -->
        <div class="overlay active" id="screen-start">
            <h1>Reflex<br>Master</h1>
            <p style="margin-bottom: 20px; text-align: center; max-width: 600px; line-height: 1.6;">
                Clicca i <span style="color:var(--primary)">target</span> velocemente.<br>
                Evita di cliccare a vuoto o perderai punti.<br>
                Prendi i power-up per bonus!
            </p>
            <button id="btn-start">Inizia Partita</button>
        </div>

        <!-- Pause Screen -->
        <div class="overlay" id="screen-pause">
            <h1>Pausa</h1>
            <button id="btn-resume">Riprendi</button>
            <button id="btn-quit">Menu Principale</button>
        </div>

        <!-- Game Over Screen -->
        <div class="overlay" id="screen-gameover">
            <h1 style="color: var(--secondary)">GAME OVER</h1>
            <div class="stat-box" style="margin-bottom: 2rem;">
                <div class="stat-label">PUNTEGGIO FINALE</div>
                <div class="stat-value" id="final-score" style="font-size: 3rem; color: var(--accent);">0</div>
            </div>
            <button id="btn-restart">Rigioca</button>
            <button id="btn-menu">Menu</button>
        </div>
    </div>

    <script>
        /**
         * AUDIO SYSTEM (Synthesized sounds using Web Audio API)
         * No external files needed, low latency.
         */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const Sound = {
            playTone: (freq, type, duration, vol = 0.1) => {
                if(audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            },
            hit: () => Sound.playTone(600 + Math.random()*200, 'sine', 0.1, 0.1),
            miss: () => Sound.playTone(150, 'sawtooth', 0.3, 0.05),
            powerup: () => {
                Sound.playTone(400, 'square', 0.1, 0.05);
                setTimeout(() => Sound.playTone(600, 'square', 0.1, 0.05), 100);
                setTimeout(() => Sound.playTone(800, 'square', 0.2, 0.05), 200);
            },
            gameover: () => Sound.playTone(100, 'triangle', 1.0, 0.2)
        };

        /**
         * GAME CLASS
         * Manages Logic, State, and Rendering
         */
        class Game {
            constructor() {
                // DOM Elements
                this.area = document.getElementById('game-area');
                this.ui = {
                    score: document.getElementById('score'),
                    time: document.getElementById('time'),
                    combo: document.getElementById('combo'),
                    comboBar: document.getElementById('combo-bar'),
                    finalScore: document.getElementById('final-score'),
                    pauseBtn: document.getElementById('btn-pause')
                };
                this.screens = {
                    start: document.getElementById('screen-start'),
                    pause: document.getElementById('screen-pause'),
                    gameover: document.getElementById('screen-gameover')
                };

                // State
                this.state = {
                    isPlaying: false,
                    isPaused: false,
                    score: 0,
                    time: 60,
                    combo: 1,
                    comboTimer: 0,
                    maxComboTime: 2000, // ms
                    spawnTimer: 0,
                    nextSpawnIn: 1000,
                    difficulty: 1
                };

                this.lastFrameTime = 0;
                this.animationId = null;

                this.bindEvents();
                this.setupCursor();
            }

            setupCursor() {
                const dot = document.querySelector('.cursor-dot');
                const circle = document.querySelector('.cursor-circle');
                
                let mouseX = window.innerWidth / 2;
                let mouseY = window.innerHeight / 2;
                let circleX = mouseX;
                let circleY = mouseY;

                document.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                    // Instant update for dot
                    dot.style.transform = `translate(${mouseX}px, ${mouseY}px) translate(-50%, -50%)`;
                });

                // Smooth follow for circle using RAF
                const animateCursor = () => {
                    // Linear interpolation (Lerp) for smoothness
                    circleX += (mouseX - circleX) * 0.15;
                    circleY += (mouseY - circleY) * 0.15;
                    circle.style.transform = `translate(${circleX}px, ${circleY}px) translate(-50%, -50%)`;
                    requestAnimationFrame(animateCursor);
                };
                animateCursor();

                // Interactive hover state
                document.addEventListener('mouseover', (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('target')) {
                        circle.classList.add('hovered');
                    }
                });
                document.addEventListener('mouseout', (e) => {
                    circle.classList.remove('hovered');
                });
            }

            bindEvents() {
                // Event Delegation for Game Area (Performance Boost)
                this.area.addEventListener('mousedown', (e) => {
                    if (!this.state.isPlaying || this.state.isPaused) return;
                    
                    if (e.target.classList.contains('target')) {
                        this.handleTargetHit(e.target);
                    } else if (e.target.classList.contains('powerup')) {
                        this.handlePowerupHit(e.target);
                    } else {
                        // Click on background = penalty
                        this.handleMiss(e.clientX, e.clientY);
                    }
                });

                // Buttons
                document.getElementById('btn-start').onclick = () => this.start();
                document.getElementById('btn-restart').onclick = () => this.start();
                document.getElementById('btn-resume').onclick = () => this.resume();
                document.getElementById('btn-pause').onclick = () => this.pause();
                document.getElementById('btn-quit').onclick = () => this.showScreen('start');
                document.getElementById('btn-menu').onclick = () => this.showScreen('start');
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' || e.key === 'p') {
                        if (this.state.isPlaying && !this.state.isPaused) this.pause();
                        else if (this.state.isPaused) this.resume();
                    }
                });
            }

            showScreen(name) {
                Object.values(this.screens).forEach(s => s.classList.remove('active'));
                if (name === 'game') return; // No overlay for game
                this.screens[name].classList.add('active');
                
                if (name !== 'game' && name !== 'pause') {
                    this.state.isPlaying = false;
                    this.clearArea();
                }
            }

            start() {
                this.state = {
                    isPlaying: true,
                    isPaused: false,
                    score: 0,
                    time: 60,
                    combo: 1,
                    comboTimer: 2000,
                    maxComboTime: 2000,
                    spawnTimer: 0,
                    nextSpawnIn: 800,
                    difficulty: 1
                };
                
                this.updateUI();
                this.clearArea();
                this.showScreen('game');
                this.lastFrameTime = performance.now();
                this.loop(this.lastFrameTime);
                
                // Immediate spawn
                this.spawnTarget();
            }

            pause() {
                this.state.isPaused = true;
                this.showScreen('pause');
                cancelAnimationFrame(this.animationId);
            }

            resume() {
                this.state.isPaused = false;
                this.showScreen('game');
                this.lastFrameTime = performance.now();
                this.loop(this.lastFrameTime);
            }

            gameover() {
                this.state.isPlaying = false;
                Sound.gameover();
                this.ui.finalScore.textContent = this.state.score;
                this.showScreen('gameover');
                cancelAnimationFrame(this.animationId);
            }

            loop(timestamp) {
                if (!this.state.isPlaying) return;

                const deltaTime = timestamp - this.lastFrameTime;
                this.lastFrameTime = timestamp;

                this.update(deltaTime);
                this.animationId = requestAnimationFrame((t) => this.loop(t));
            }

            update(dt) {
                // Timer Logic
                this.state.time -= dt / 1000;
                if (this.state.time <= 0) {
                    this.state.time = 0;
                    this.gameover();
                    return;
                }

                // Combo Decay logic
                if (this.state.combo > 1) {
                    this.state.comboTimer -= dt;
                    if (this.state.comboTimer <= 0) {
                        this.state.combo = 1;
                        this.createFloatingText("COMBO LOST", window.innerWidth/2, window.innerHeight/2, '#ff0055');
                    }
                }

                // Spawning Logic
                this.state.spawnTimer += dt;
                
                // Difficulty scaling: As score goes up, spawn faster
                const currentSpawnRate = Math.max(300, 1000 - (this.state.score * 5)); 
                
                if (this.state.spawnTimer > currentSpawnRate) {
                    this.spawnTarget();
                    this.state.spawnTimer = 0;
                }

                // Random Powerup Spawn (rare)
                if (Math.random() < 0.005) this.spawnPowerup();

                // UI Update (throttled slightly visually by RAF naturally)
                this.updateUI();
            }

            spawnTarget() {
                const size = Math.max(40, 70 - (this.state.score / 20)); // Targets get smaller
                const el = document.createElement('div');
                el.classList.add('target');
                el.style.width = size + 'px';
                el.style.height = size + 'px';
                
                // Color based on value
                const value = Math.floor(Math.random() * 5) + 1;
                const hue = (value * 60) % 360;
                el.style.color = `hsl(${hue}, 100%, 70%)`;
                el.textContent = value;
                el.dataset.value = value;
                el.dataset.created = Date.now();

                const { x, y } = this.getRandomPosition(size);
                el.style.left = x + 'px';
                el.style.top = y + 'px';

                this.area.appendChild(el);

                // Auto-remove target after some time (missed opportunity)
                const lifeTime = Math.max(1000, 3000 - (this.state.score * 10));
                setTimeout(() => {
                    if(el.parentNode && !this.state.isPaused) {
                        el.remove();
                        // Reset combo on miss? Optional. Let's strictly decay combo bar instead.
                    }
                }, lifeTime);
            }

            spawnPowerup() {
                const type = Math.random() > 0.5 ? 'time' : 'points';
                const el = document.createElement('div');
                el.classList.add('powerup');
                el.textContent = type === 'time' ? '⏳' : '⭐';
                el.dataset.type = type;
                
                const { x, y } = this.getRandomPosition(50);
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                
                this.area.appendChild(el);
                setTimeout(() => { if(el.parentNode) el.remove(); }, 4000);
            }

            getRandomPosition(padding) {
                const hudHeight = 80;
                const w = this.area.clientWidth - padding * 2;
                const h = this.area.clientHeight - padding * 2 - hudHeight;
                return {
                    x: Math.random() * w + padding,
                    y: Math.random() * h + padding + hudHeight
                };
            }

            handleTargetHit(target) {
                if (target.classList.contains('popped')) return;
                
                Sound.hit();
                target.classList.add('popped'); // Trigger CSS animation
                
                const points = parseInt(target.dataset.value) * this.state.combo;
                this.state.score += points;
                
                // Increase combo
                this.state.combo = Math.min(this.state.combo + 1, 10); // Max combo 10x
                this.state.comboTimer = this.state.maxComboTime;

                // Visual Feedback
                this.createFloatingText(`+${points}`, parseFloat(target.style.left), parseFloat(target.style.top), '#00f3ff');
                
                // Remove element after animation finishes
                setTimeout(() => target.remove(), 200);
            }

            handlePowerupHit(powerup) {
                Sound.powerup();
                powerup.remove();
                
                if (powerup.dataset.type === 'time') {
                    this.state.time += 5;
                    this.createFloatingText('+5s', parseFloat(powerup.style.left), parseFloat(powerup.style.top), '#ffee00');
                } else {
                    this.state.score += 50;
                    this.createFloatingText('+50 PTS', parseFloat(powerup.style.left), parseFloat(powerup.style.top), '#ffee00');
                }
            }

            handleMiss(x, y) {
                Sound.miss();
                // Penalty Logic
                const penalty = 5 * this.state.combo;
                this.state.score = Math.max(0, this.state.score - penalty);
                
                // Reset Combo
                this.state.combo = 1;
                this.state.comboTimer = 0;

                this.createFloatingText(`-${penalty}`, x, y, '#ff0055');
            }

            createFloatingText(text, x, y, color) {
                const el = document.createElement('div');
                el.classList.add('float-text');
                el.textContent = text;
                el.style.left = x + 'px';
                el.style.top = y + 'px';
                el.style.color = color;
                this.area.appendChild(el);
                setTimeout(() => el.remove(), 800);
            }

            updateUI() {
                this.ui.score.textContent = Math.floor(this.state.score);
                this.ui.time.textContent = Math.ceil(this.state.time);
                this.ui.combo.textContent = `x${this.state.combo}`;
                
                // Combo Bar
                const pct = (this.state.comboTimer / this.state.maxComboTime) * 100;
                this.ui.comboBar.style.width = `${Math.max(0, pct)}%`;
            }

            clearArea() {
                this.area.innerHTML = '';
            }
        }

        // Initialize Game
        window.addEventListener('load', () => {
            const game = new Game();
        });

    </script>
</body>
</html>
